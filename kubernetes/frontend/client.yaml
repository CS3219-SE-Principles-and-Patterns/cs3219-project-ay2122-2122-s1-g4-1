# contains deployment pods, service configuration for api gateway to call, and HPA configuration
# nginx ingress
# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.4/deploy/static/provider/cloud/deploy.yaml
# metrics
# kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: auctionfrontend
spec:
  selector:
    matchLabels:
      run: auctionfrontend
  replicas: 2
  template:
    metadata:
      labels:
        run: auctionfrontend
    spec:
      containers:
      - name: auctionfrontend
        image: auctionfrontend
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
        resources:
          limits:
            cpu: 500m
          requests:
            cpu: 200m
---
apiVersion: v1
kind: Service
metadata:
  name: auctionfrontend
  labels:
    run: auctionfrontend
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 3000
      nodePort: 30007
  selector:
    run: auctionfrontend
---
apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: auctionfrontend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auctionfrontend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 30

# ---

# This should be for the api gateway
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: auction-api-gateway
#   namespace: default
#   annotations:
#     kubernetes.io/ingress.class: "nginx"
#     nginx.ingress.kubernetes.io/rewrite-target: /
#     nginx.ingress.kubernetes.io/affinity: "cookie"
#     nginx.ingress.kubernetes.io/affinity-mode: "balanced"
#     nginx.ingress.kubernetes.io/session-cookie-name: "route"
#     nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
#     nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"

# spec:
#   defaultBackend:
#       service:
#         name: auctionbackend-auctiondetails
#         port:
#           number: 80
#   rules:
#   - host : kubernetes.docker.internal
#   - http:
#       paths:
#       - path: /auctiondetails
#         pathType: Prefix
#         backend:
#           service:
#             name: auctionbackend-auctiondetails
#             port:
#               number: 8080

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: auctionfrontend
#   namespace: default
# spec:
#   replicas: 2
#   selector:
#     matchLabels:
#       app: auctionfrontend
#   template:
#     metadata:
#       labels:
#         app: auctionfrontend
#     spec:
#       containers:
#       - name: auctionfrontend
#         image: auctionfrontend
#         imagePullPolicy: IfNotPresent
#         ports:
#         # REMEMBER TO USE PORT THAT NODEJS EXPOSES NOT DOCKERFILE. REACT IS 3000 BY DEFAULT
#         - containerPort: 3000
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: auctionfrontend
#   namespace: default
# spec:
#   type: LoadBalancer
#   selector:
#     app: auctionfrontend
#   ports:
#   - port: 8080
#     # REMEMBER TO USE PORT THAT NODEJS EXPOSES NOT DOCKERFILE
#     targetPort: 3000
